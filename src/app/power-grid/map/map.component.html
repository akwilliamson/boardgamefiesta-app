<svg xmlns="http://www.w3.org/2000/svg" version="1.1"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     width="100%" height="100%"
     [attr.viewBox]="'0 0 ' + base.width + ' ' + base.height">
  <defs>
    <clipPath id="base">
      <rect x="0" y="0" width="100%" height="100%" rx="4px"/>
    </clipPath>
    <filter id="cityShadow">
      <feDropShadow dx="0" dy="0" stdDeviation="1"/>
    </filter>
    <filter id="textShadow">
      <feDropShadow dx="1.5" dy="1.5" stdDeviation="0.2"/>
    </filter>

    <g id="house" transform="translate(-13,-9.5) scale(0.18)">
      <g transform="translate(-6.7169622,-9.1196894)">
        <g transform="matrix(0.26458333,0,0,0.26458333,4.9747309,6.256733)">
          <path
            d="m 365.82,54.076 46.252,7.841 30.885,24.921 84.957,62.71 8.624,6.114 c 0.626,4.699 0.626,8.769 0,13.475 -19.127,5.175 -38.728,9.089 -57.53,15.366 -2.353,2.353 -5.798,4.077 -5.958,7.514 -3.451,26.041 -4.247,50.006 -3.768,75.25 l -2.342,5.026 c -44.524,42.95 -91.082,86.994 -122.9,137.32 -0.156,3.44 -4.546,2.494 -6.893,2.189 -95.31,-18.67 -181.22,-59.89 -264.46,-108.01 -10.97,-40.611 -13.006,-85.128 -12.693,-129.02 -14.108,0 -29.944,1.254 -44.357,2.189 l -1.575,-2.979 c 0.786,-8.3 1.575,-15.349 2.19,-23.652 L 67.515,102.507 123.947,52.196 C 137.12,41.38 150.286,29.93 162.976,18.645 l 103.15,18.814 99.69,16.604 z"/>
          <path
            d="m 207.5,61.132 95.475,59.89 51.882,32.287 c -0.476,1.88 2.973,0.935 4.23,2.353 l 28.849,18.028 c 4.229,7.365 1.557,19.746 2.35,28.991 -27.431,-19.592 -54.716,-39.192 -83.088,-56.115 -48.274,-33.541 -97.967,-61.92 -144.53,-98.913 l -1.877,0.313 c -42.17,35.587 -84.016,71.01 -125.26,109.11 l -13.163,11.282 c 0.473,-5.634 -1.407,-11.599 2.976,-16.138 21.48,-21.483 45.616,-41.386 68.034,-62.866 l 68.507,-58.945 c 15.21,9.104 30.26,20.855 45.62,30.733 z"/>
          <path
            d="m 290.26,49.217 85.769,13.479 c 15.828,2.2 33.388,1.415 44.356,15.054 37.149,27.586 72.414,54.238 110.51,80.101 -41.389,6.896 -86.22,10.82 -129.01,15.374 -13.322,0.465 -23.363,-11.457 -34.959,-17.254 -63.95,-40.131 -128.39,-78.844 -191.09,-121.8 l -3.761,-2.662 c 39.65,5.172 78.68,11.752 118.18,17.709 z"/>
          <path
            d="m 320.37,160.83 25.859,17.708 c -1.247,35.275 -3.121,72.58 -5.645,106.44 l -2.189,89.976 -0.775,24.455 C 231.78125,382.62505 114.447,319.25072 78.026,300.815 70.501,274.631 69.243,244.066 67.519,218.829 66.112,191.082 67.054,163.343 66.737,134.181 97.302,105.958 129.446,79.789 161.889,56.265 l 48.59,33.551 109.9,70.995 z"/>
          <path
            d="m 532.14,165.38 c -29.311,6.739 -60.193,11.755 -87.32,21.789 -1.867,-1.571 -3.121,2.041 -5.627,1.884 -15.374,4.383 -30.723,9.245 -45.933,13.94 0,-8.775 -0.156,-16.297 1.561,-24.131 34.81,-5.637 71.177,-8.467 105.65,-13.482 10.514,-1.098 21.319,-2.197 31.198,-3.458 l 0.47,3.46 z"/>
          <path
            d="m 390.28,210.84 h 3.764 c 23.19,-7.678 47.333,-13.166 70.377,-21.327 -0.299,24.449 -1.095,53.78 -0.781,77.439 -18.339,18.812 -36.688,32.612 -53.141,51.107 -24.936,23.523 -47.344,50.791 -69.133,76.811 -0.637,-70.7 7.834,-138.57 11.605,-210.69 12.53,8.63 25.08,17.1 37.3,26.66 z"/>
        </g>
      </g>
    </g>
  </defs>

  <image x="0" y="0" width="100%" height="100%" [attr.href]="base.url" clip-path="url(#base)"/>

  <g *ngFor="let conn of connections" class="connection">
    <line [attr.x1]="conn.x1" [attr.y1]="conn.y1"
          [attr.x2]="conn.x2" [attr.y2]="conn.y2"
          [attr.stroke-width]="conn.width + 'px'"/>
    <line [attr.x1]="conn.x1" [attr.y1]="conn.y1"
          [attr.x2]="conn.x2" [attr.y2]="conn.y2"
          stroke="grey" [attr.stroke-width]="(conn.width - 2) + 'px'"/>
  </g>

  <ng-container *ngFor="let city of cities">
    <ng-template #popoverContent>
      {{city.name}}
    </ng-template>

    <g [attr.transform]="'translate(' + city.x + ',' + city.y + ')'" class="city"
       [ngClass]="{selectable:canSelectCity(city.name)}"
       [ngbPopover]="popoverContent" triggers="mouseenter:mouseleave" container="body">
      <circle r="20px" fill="black"/>
      <circle r="19px" fill="grey"/>

      <text y="-10"
            font-size="6px"
            style="filter: url(#textShadow); fill: #886e5f"
            font-family="sans-serif"
            font-weight="bold"
            text-anchor="middle" dominant-baseline="middle">10
      </text>
      <text x="-10" y="8"
            font-size="6px"
            style="filter: url(#textShadow); fill: #dad6b9"
            font-family="sans-serif"
            font-weight="bold"
            text-anchor="middle" dominant-baseline="middle">15
      </text>
      <text x="9" y="8"
            font-size="6px"
            style="filter: url(#textShadow); fill: #81897d"
            font-family="sans-serif"
            font-weight="bold"
            text-anchor="middle" dominant-baseline="middle">20
      </text>

      <g *ngFor="let playerId of state.cities[city]; index as i"
         [attr.transform]="'translate(' + (i === 0 ? 0 : i === 1 ? -10 : 9) + ',' + (i === 0 ? -10 : 8) + ')'"
         [class]="'fill-' + table.players[playerId].color"
         style="stroke:black; stroke-width:6;filter: drop-shadow(2px 2px 1px rgba(0, 0, 0, .8));">
        <use xlink:href="#house"/>
      </g>

      <text y="20px"
            font-size="8px"
            style="filter: url(#textShadow); fill: white"
            font-family="sans-serif"
            font-weight="bold"
            text-anchor="middle" dominant-baseline="middle">
        {{city.name}}
      </text>
    </g>
  </ng-container>

  <g *ngFor="let conn of connections">
    <g *ngIf="conn.cost > 0">
      <circle [attr.r]="conn.r + 'px'" fill="black" [attr.cx]="conn.cx" [attr.cy]="conn.cy"
              style="filter: drop-shadow( 0px 0px 2px rgba(0, 0, 0, .8));"/>
      <circle [attr.r]="(conn.r - 1) + 'px'"
              [attr.fill]="conn.cost >= 16 ? 'yellow' : conn.cost >= 8 ? 'orange' : 'silver'" [attr.cx]="conn.cx"
              [attr.cy]="conn.cy"/>
      <circle [attr.r]="(conn.r - 2) + 'px'" fill="grey" [attr.cx]="conn.cx" [attr.cy]="conn.cy"/>

      <text [attr.x]="conn.cx" [attr.y]="conn.cy"
            [attr.font-size]="conn.r + 'px'"
            style="filter: url(#textShadow); fill: white"
            font-family="sans-serif"
            font-weight="bold"
            text-anchor="middle" dominant-baseline="middle">
        {{conn.cost}}
      </text>
    </g>
  </g>

</svg>
